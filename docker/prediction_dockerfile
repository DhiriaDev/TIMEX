#syntax=docker/dockerfile:1

FROM python:3.9-slim-buster

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=on \
    POETRY_HOME="/opt/poetry" \
    POETRY_NO_INTERACTION=1

# prepend poetry and venv to path
ENV PATH="$POETRY_HOME/bin:$PATH"

RUN apt-get update && \
    apt-get install --no-install-recommends -y \
    # deps for installing poetry
    curl \
    # deps for building python deps
    build-essential && \
    python -m ensurepip --upgrade

WORKDIR $POETRY_HOME 
RUN curl -sSL https://install.python-poetry.org | python -
RUN poetry self update

WORKDIR /timexdocker
ADD TIMEX ./TIMEX

ADD pyproject.toml poetry.lock ./
RUN poetry config virtualenvs.create false \
    && poetry update

WORKDIR /timexdocker/TIMEX 
RUN poetry config virtualenvs.create false \
    && poetry install --with data_prediction

WORKDIR /timexdocker
ADD redpanda_modules ./redpanda_modules
ADD tests/prediction_instance.py ./
ADD redpanda-ca.crt ./

ENTRYPOINT [ "python", "./prediction_instance.py"]
CMD [""]